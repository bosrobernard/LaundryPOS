<div class="form-container">
    <!-- Header -->
    <div class="form-header">
        <div class="header-content">
            <button mat-icon-button (click)="goBack()" class="back-btn">
                <i class="ri-arrow-left-line"></i>
            </button>
            <div class="title-section">
                <h1>{{isEditMode ? 'Edit Order' : 'Create New Order'}}</h1>
                <p>{{isEditMode ? 'Update order details' : 'Create a new order for customer'}}</p>
            </div>
        </div>

        <!-- Order Status Timeline -->
        <div class="order-timeline" *ngIf="isEditMode">
            <div class="timeline-item" *ngFor="let status of orderStatuses" [class.active]="currentStatus === status">
                <div class="timeline-icon">
                    <i [class]="getStatusIcon(status)"></i>
                </div>
                <div class="timeline-content">
                    <span class="status">{{status}}</span>
                    <small class="date" *ngIf="currentStatus === status">
                        {{statusDate | date:'short'}}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Content -->
    <div class="form-content">
        <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
            <!-- Customer Information -->
            <mat-card class="form-section">
                <mat-card-header>
                    <mat-card-title>
                        <i class="ri-user-line"></i>
                        Customer Information
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="customer-search">
                        <h4 class="custom-label">Search customer:</h4>
                        <mat-form-field appearance="outline" class="full-width">
                            <!-- <mat-label>Search Customer</mat-label> -->
                            <input matInput [matAutocomplete]="auto" [formControl]="customerSearch"
                                placeholder="Search by name, email, or phone">
                            <mat-icon matPrefix>search</mat-icon>
                        </mat-form-field>

                        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onCustomerSelected($event)">
                            <mat-option *ngFor="let customer of filteredCustomers$ | async" [value]="customer">
                                <div class="customer-option">
                                    <img [src]="customer.avatar || 'assets/default-avatar.png'" [alt]="customer.name"
                                        class="customer-avatar">
                                    <div class="customer-info">
                                        <span class="name">{{customer.name}}</span>
                                        <small class="email">{{customer.email}}</small>
                                    </div>
                                </div>
                            </mat-option>
                        </mat-autocomplete>
                    </div>

                    <!-- Selected Customer Preview -->
                    <div class="selected-customer" *ngIf="selectedCustomer">
                        <div class="customer-card">
                            <img [src]="selectedCustomer.avatar || 'assets/default-avatar.png'"
                                [alt]="selectedCustomer.name" class="customer-avatar">
                            <div class="customer-details">
                                <h3>{{selectedCustomer.name}}</h3>
                                <p>{{selectedCustomer.email}}</p>
                                <p>{{selectedCustomer.phone}}</p>
                                <p>{{selectedCustomer.address}}</p>
                            </div>
                            <button mat-icon-button color="warn" (click)="clearSelectedCustomer()"
                                class="remove-customer">
                                <i class="ri-close-circle-line"></i>
                            </button>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <mat-card class="form-section">
                <mat-card-header>
                    <mat-card-title>
                        <i class="ri-shopping-basket-line"></i>
                        Order Items
                    </mat-card-title>
                    <button mat-stroked-button color="primary" (click)="addOrderItem()" class="add-item-btn">
                        <i class="ri-add-line"></i>
                        Add Item
                    </button>
                </mat-card-header>
                <mat-card-content>
                    <div class="order-items" formArrayName="items">
                        <!-- Empty State -->
                        <div class="empty-items" *ngIf="orderItems.length === 0">
                            <i class="ri-shopping-basket-line"></i>
                            <p>No items added to the order yet</p>
                            <button mat-stroked-button color="primary" (click)="addOrderItem()">
                                Add First Item
                            </button>
                        </div>

                        <!-- Order Items -->
                        <div *ngFor="let item of orderItems.controls; let i = index" [formGroupName]="i"
                            class="order-item">
                            <div class="order-item-grid">
                                <!-- First Column -->
                                <div class="order-item-column">
                                    <div class="form-field">
                                        <label for="service-{{i}}">Service:</label>
                                        <mat-form-field appearance="outline">
                                            <mat-select formControlName="service" id="service-{{i}}">
                                                <mat-option *ngFor="let service of services" [value]="service.id">
                                                    <div class="service-option">
                                                        <i [class]="service.icon"></i>
                                                        <span>{{service.name}}</span>
                                                        <small>${{service.price}}</small>
                                                    </div>
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </div>

                                    <div class="form-field">
                                        <label for="quantity-{{i}}">Quantity:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput type="number" formControlName="quantity" id="quantity-{{i}}"
                                                min="1" (input)="updateItemTotal(i)">
                                        </mat-form-field>
                                    </div>
                                </div>

                                <!-- Second Column -->
                                <div class="order-item-column">
                                    <div class="form-field">
                                        <label for="price-{{i}}">Price:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput type="number" formControlName="price" id="price-{{i}}"
                                                (input)="updateItemTotal(i)">
                                            <span matPrefix>$&nbsp;</span>
                                        </mat-form-field>
                                    </div>

                                    <div class="form-field">
                                        <label for="total-{{i}}">Total:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput type="number" formControlName="total" id="total-{{i}}"
                                                readonly>
                                            <span matPrefix>$&nbsp;</span>
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>



                            <!-- Notes Field (Full Width) -->
                            <div class="form-field notes-field">
                                <label for="notes-{{i}}">Notes:</label>
                                <mat-form-field appearance="outline">
                                    <textarea matInput formControlName="notes" id="notes-{{i}}" rows="2"
                                        placeholder="Add any special instructions or notes for this item"></textarea>
                                </mat-form-field>
                            </div>

                            <!-- Action Buttons -->
                            <div class="item-actions">
                                <button mat-icon-button>

                                </button>
                                <!-- <button mat-icon-button color="warn" (click)="removeOrderItem(i)"
                                    matTooltip="Remove Item" type="button">
                                    <i class="ri-delete-bin-line"></i>
                                </button> -->
                            </div>

                            <div style="display: flex;align-self: flex-start;width: 10rem;">
                                <button color="primary" type="button" style="background: #3f51b5; color: white;padding: 1.2rem 2rem;"
                                    matTooltip="Add to Cart" (click)="addToCart(i)">Add to cart</button>
                                <i class="ri-shopping-cart-add-line"></i>
                            </div>

                        </div>


                    </div>

                    <!-- Cart Table -->
                    <div class="cart-items" *ngIf="cartItems.length > 0">
                        <h3>Cart Items</h3>
                        <table class="cart-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of cartItems; let i = index">
                                    <td>{{item.service}}</td>
                                    <td>{{item.quantity}}</td>
                                    <td>${{item.price}}</td>
                                    <td>${{item.total}}</td>
                                    <td>{{item.notes}}</td>
                                    <td>
                                        <button mat-icon-button color="warn" (click)="removeFromCart(i)" type="button">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot style="padding-top: 3rem;">
                                <tr>
                                    <td colspan="3" class="text-right">Subtotal:</td>
                                    <td>${{getCartTotal() | number:'1.2-2'}}</td>
                                    <td colspan="2"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-right">Tax ({{taxRate}}%):</td>
                                    <td>${{getCartTax() | number:'1.2-2'}}</td>
                                    <td colspan="2"></td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="3" class="text-right">Total:</td>
                                    <td>${{getCartGrandTotal() | number:'1.2-2'}}</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Delivery Information -->
            <mat-card class="form-section">
                <mat-card-header>
                    <mat-card-title>
                        <i class="ri-truck-line"></i>
                        Delivery Information
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="form-grid two-columns">
                        <div class="form-field">
                            <label>Delivery/Pickup Date:</label>
                            <mat-form-field appearance="outline">
                                <input matInput [matDatepicker]="picker" formControlName="deliveryDate">
                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>
                        </div>
            
                        <div class="form-field">
                            <label>Time slot:</label>
                            <mat-form-field appearance="outline">
                                <mat-select formControlName="timeSlot">
                                    <mat-option *ngFor="let slot of timeSlots" [value]="slot.value">
                                        {{slot.label}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
            
                        <div class="address-section full-width" formGroupName="deliveryAddress">
                            <mat-checkbox formControlName="sameAsCustomer" (change)="onSameAddressChange($event)">
                                Same as customer address
                            </mat-checkbox>
            
                            <ng-container *ngIf="!orderForm?.get('deliveryAddress.sameAsCustomer')?.value">
                                <div class="address-grid">
                                    <div class="form-field">
                                        <label>Street Address:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput formControlName="street">
                                        </mat-form-field>
                                    </div>
            
                                    <div class="form-field">
                                        <label>City:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput formControlName="city">
                                        </mat-form-field>
                                    </div>
            
                                    <div class="form-field">
                                        <label>State:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput formControlName="state">
                                        </mat-form-field>
                                    </div>
            
                                    <div class="form-field">
                                        <label>ZIP Code:</label>
                                        <mat-form-field appearance="outline">
                                            <input matInput formControlName="zipCode">
                                        </mat-form-field>
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
            

            <!-- Additional Information -->
            <mat-card class="form-section">
                <mat-card-header>
                    <mat-card-title>
                        <i class="ri-information-line"></i>
                        Additional Information
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="form-grid">
                        <div class="two-columns">
                            <div class="form-field">
                                <label>Payment Method:</label>
                                <mat-form-field appearance="outline">
                                    <mat-select formControlName="paymentMethod">
                                        <mat-option value="cash">Cash on Delivery</mat-option>
                                        <mat-option value="card">Credit/Debit Card</mat-option>
                                        <mat-option value="online">Online Payment</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
            
                            <div class="form-field">
                                <label>Priority levels:</label>
                                <mat-form-field appearance="outline">
                                    <mat-select formControlName="priority">
                                        <mat-option value="normal">Normal</mat-option>
                                        <mat-option value="rush">Rush</mat-option>
                                        <mat-option value="express">Express</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
            
                        <div class="form-field full-width">
                            <label>Special Instructions:</label>
                            <mat-form-field appearance="outline">
                                <textarea matInput formControlName="instructions" rows="4"></textarea>
                            </mat-form-field>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Form Actions -->
         <!-- Form Actions -->
<div class="form-actions">
    <button mat-stroked-button type="button" (click)="goBack()">
        Cancel
    </button>
    <button mat-raised-button color="primary" type="submit" 
        [disabled]="orderForm.invalid || isSubmitting || cartItems.length === 0">
        <mat-spinner diameter="20" *ngIf="isSubmitting"></mat-spinner>
        <span *ngIf="!isSubmitting">
            {{isEditMode ? 'Update Order' : 'Create Order'}}
        </span>
    </button>
</div>


        </form>
    </div>
</div>
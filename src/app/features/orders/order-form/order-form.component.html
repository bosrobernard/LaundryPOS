<div class="form-container">
    <!-- Header -->
    <div class="form-header">
      <div class="header-content">
        <button mat-icon-button (click)="goBack()" class="back-btn">
          <i class="ri-arrow-left-line"></i>
        </button>
        <div class="title-section">
          <h1>{{isEditMode ? 'Edit Order' : 'Create New Order'}}</h1>
          <p>{{isEditMode ? 'Update order details' : 'Create a new order for customer'}}</p>
        </div>
      </div>

      <!-- Order Status Timeline -->
      <div class="order-timeline" *ngIf="isEditMode">
        <div class="timeline-item" 
             *ngFor="let status of orderStatuses" 
             [class.active]="currentStatus === status">
          <div class="timeline-icon">
            <i [class]="getStatusIcon(status)"></i>
          </div>
          <div class="timeline-content">
            <span class="status">{{status}}</span>
            <small class="date" *ngIf="currentStatus === status">
              {{statusDate | date:'short'}}
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
        <!-- Customer Information -->
        <mat-card class="form-section">
          <mat-card-header>
            <mat-card-title>
              <i class="ri-user-line"></i>
              Customer Information
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="customer-search">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Search Customer</mat-label>
                <input matInput
                       [matAutocomplete]="auto"
                       [formControl]="customerSearch"
                       placeholder="Search by name, email, or phone">
                <mat-icon matPrefix>search</mat-icon>
              </mat-form-field>

              <mat-autocomplete #auto="matAutocomplete" 
                              (optionSelected)="onCustomerSelected($event)">
                <mat-option *ngFor="let customer of filteredCustomers$ | async"
                           [value]="customer">
                  <div class="customer-option">
                    <img [src]="customer.avatar || 'assets/default-avatar.png'"
                         [alt]="customer.name"
                         class="customer-avatar">
                    <div class="customer-info">
                      <span class="name">{{customer.name}}</span>
                      <small class="email">{{customer.email}}</small>
                    </div>
                  </div>
                </mat-option>
              </mat-autocomplete>
            </div>

            <!-- Selected Customer Preview -->
            <div class="selected-customer" *ngIf="selectedCustomer">
              <div class="customer-card">
                <img [src]="selectedCustomer.avatar || 'assets/default-avatar.png'"
                     [alt]="selectedCustomer.name"
                     class="customer-avatar">
                <div class="customer-details">
                  <h3>{{selectedCustomer.name}}</h3>
                  <p>{{selectedCustomer.email}}</p>
                  <p>{{selectedCustomer.phone}}</p>
                  <p>{{selectedCustomer.address}}</p>
                </div>
                <button mat-icon-button color="warn" 
                        (click)="clearSelectedCustomer()"
                        class="remove-customer">
                  <i class="ri-close-circle-line"></i>
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Order Items -->
        <mat-card class="form-section">
          <mat-card-header>
            <mat-card-title>
              <i class="ri-shopping-basket-line"></i>
              Order Items
            </mat-card-title>
            <button mat-stroked-button color="primary" 
                    (click)="addOrderItem()"
                    class="add-item-btn">
              <i class="ri-add-line"></i>
              Add Item
            </button>
          </mat-card-header>
          <mat-card-content>
            <div class="order-items" formArrayName="items">
              <div *ngFor="let item of orderItems.controls; let i = index"
                   [formGroupName]="i"
                   class="order-item">
                <div class="item-content">
                  <mat-form-field appearance="outline">
                    <mat-label>Service</mat-label>
                    <mat-select formControlName="service">
                      <mat-option *ngFor="let service of services" 
                                [value]="service.id">
                        <div class="service-option">
                          <i [class]="service.icon"></i>
                          <span>{{service.name}}</span>
                          <small>${{service.price}}</small>
                        </div>
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Quantity</mat-label>
                    <input matInput type="number" formControlName="quantity"
                           min="1" (input)="updateItemTotal(i)">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Price</mat-label>
                    <input matInput type="number" formControlName="price"
                           (input)="updateItemTotal(i)">
                    <span matPrefix>$&nbsp;</span>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Total</mat-label>
                    <input matInput type="number" formControlName="total" readonly>
                    <span matPrefix>$&nbsp;</span>
                  </mat-form-field>

                  <button mat-icon-button color="warn" 
                          (click)="removeOrderItem(i)"
                          class="remove-item">
                    <i class="ri-delete-bin-line"></i>
                  </button>
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Notes</mat-label>
                  <textarea matInput formControlName="notes" rows="2"
                           placeholder="Add any special instructions or notes for this item">
                  </textarea>
                </mat-form-field>
              </div>

              <!-- Empty State -->
              <div class="empty-items" *ngIf="orderItems.length === 0">
                <i class="ri-shopping-basket-line"></i>
                <p>No items added to the order yet</p>
                <button mat-stroked-button color="primary" (click)="addOrderItem()">
                  Add First Item
                </button>
              </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary" *ngIf="orderItems.length > 0">
              <div class="summary-row">
                <span>Subtotal</span>
                <span>${{getSubtotal() | number:'1.2-2'}}</span>
              </div>
              <div class="summary-row">
                <span>Tax ({{taxRate}}%)</span>
                <span>${{getTax() | number:'1.2-2'}}</span>
              </div>
              <div class="summary-row total">
                <span>Total</span>
                <span>${{getTotal() | number:'1.2-2'}}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Delivery Information -->
        <mat-card class="form-section">
          <mat-card-header>
            <mat-card-title>
              <i class="ri-truck-line"></i>
              Delivery Information
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Delivery Date</mat-label>
                <input matInput [matDatepicker]="picker" 
                       formControlName="deliveryDate">
                <mat-datepicker-toggle matSuffix [for]="picker">
                </mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Time Slot</mat-label>
                <mat-select formControlName="timeSlot">
                  <mat-option *ngFor="let slot of timeSlots" [value]="slot.value">
                    {{slot.label}}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <div class="address-section" formGroupName="deliveryAddress">
                <mat-checkbox formControlName="sameAsCustomer" 
                            (change)="onSameAddressChange($event)">
                  Same as customer address
                </mat-checkbox>

                <ng-container *ngIf="!orderForm.get('deliveryAddress.sameAsCustomer')?.value">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Street Address</mat-label>
                    <input matInput formControlName="street">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>City</mat-label>
                    <input matInput formControlName="city">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>State</mat-label>
                    <input matInput formControlName="state">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>ZIP Code</mat-label>
                    <input matInput formControlName="zipCode">
                  </mat-form-field>
                </ng-container>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Additional Information -->
        <mat-card class="form-section">
          <mat-card-header>
            <mat-card-title>
              <i class="ri-information-line"></i>
              Additional Information
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Payment Method</mat-label>
                <mat-select formControlName="paymentMethod">
                  <mat-option value="cash">Cash on Delivery</mat-option>
                  <mat-option value="card">Credit/Debit Card</mat-option>
                  <mat-option value="online">Online Payment</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Priority Level</mat-label>
                <mat-select formControlName="priority">
                  <mat-option value="normal">Normal</mat-option>
                  <mat-option value="rush">Rush</mat-option>
                  <mat-option value="express">Express</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Special Instructions</mat-label>
                <textarea matInput formControlName="instructions" rows="4">
                </textarea>
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Form Actions -->
        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="goBack()">
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit"
                  [disabled]="orderForm.invalid || isSubmitting">
            <mat-spinner diameter="20" *ngIf="isSubmitting"></mat-spinner>
            <span *ngIf="!isSubmitting">
              {{isEditMode ? 'Update Order' : 'Create Order'}}
            </span>
          </button>
        </div>
    </form>
</div>
</div>